# シャンパンボトル シワ検査システム - YOLOv8学習版

オリジナルシャンパンボトルのシュリンクフィルムに発生するシワをYOLOv8セグメンテーションで自動検出するシステムです。

## プロジェクト概要

### 目的
- シュリンクフィルムのシワをYOLOv8で高精度検出
- 3000枚のデータセットで学習
- 柄に依存しない検出精度90%以上を目標

### アプローチ
- **データ収集**: main.pyの自動撮影機能で3000枚収集
- **アノテーション**: シワ領域をポリゴンで手動マーク
- **学習**: YOLOv8セグメンテーションで学習
- **判定**: シワの位置・数・面積から OK/NG判定

### 背景
- 画像処理のみでは柄とシワの完全な分離が困難
- フォトメトリックステレオ法でも柄の影響を完全に除去できず
- 学習ベースのアプローチに移行

## ハードウェア構成

### 購入済み機材
1. **カメラ**: オムロンセンテック STC-MCS231U3V（79,980円）
2. **レンズ**: Dioche 8mm F1.6 CCTVレンズ（6,869円）
3. **USBケーブル**: UGREEN USB3.0 MicroB 2m（1,399円）
4. **PC**: ASUS Vivobook 15 X1502VA（所有済み）

### 今後必要な機材
- **照明（LED）**: 5,000-30,000円
- **カメラ固定治具**: 5,000-10,000円（準備済み）

## ソフトウェア構成

### システム要件
- OS: Windows
- Python: 3.8以上
- StCamUSBPack: インストール済み

### ファイル構成
```
wrinkle_detection/
├── main.py              # メインプログラム（GUI付き）
├── camera_control.py    # STC-MCS231U3Vカメラ制御
├── image_processing.py  # シワ検出アルゴリズム
├── config.py           # カメラ設定・検出パラメータ
├── utils.py            # ログ・画像保存等
├── requirements.txt    # 必要なライブラリ
├── CLAUDE.md           # Claude Code開発ガイド
├── README.md           # このファイル
├── test_images/        # テスト画像保存
└── results/            # 検出結果保存
```

## セットアップ

### 1. Pythonライブラリのインストール

```bash
cd wrinkle_detection
pip install -r requirements.txt
```

### 2. カメラドライバ確認
- StCamUSBPackがインストールされていることを確認
- カメラをUSB3.0ポートに接続

### 3. 初回起動

```bash
python main.py
```

## 使い方

### Phase 1: データ収集（3000枚）

1. **カメラ起動とYOLO自動撮影**
```bash
python main.py
```
   - 「カメラ起動」ボタンをクリック
   - 「自動撮影 開始」ボタンで自動収集
   - ボトルを検出すると自動的に撮影
   - 目標: OK 1500枚、NG 1500枚

2. **画像のレビューとラベリング**
   - 「OK画像をレビュー」ボタン
   - OK/NGを振り分け
   - 「シワをアノテーション」でシワ領域をマーク（ポリゴン）

### Phase 2: データセット準備

```bash
python prepare_yolo_dataset.py
```
   - dataset/ok, dataset/ng → yolo_dataset/ にコピー
   - 訓練用80%、検証用20%に分割
   - YOLO形式（dataset.yaml）を生成

### Phase 3: YOLOv8学習

```bash
yolo task=segment mode=train model=yolov8n-seg.pt data=yolo_dataset/dataset.yaml epochs=100 imgsz=640
```
   - エポック数: 100-200
   - 画像サイズ: 640x640
   - 学習時間: 数時間（GPU推奨）

### Phase 4: 学習済みモデルで検出

```python
from ultralytics import YOLO

# 学習済みモデルをロード
model = YOLO('runs/segment/train/weights/best.pt')

# シワを検出
results = model(bottle_image)
wrinkles = results[0].masks  # シワのマスク

# OK/NG判定
if wrinkles is None or len(wrinkles) < 3:
    result = "OK"
else:
    result = "NG"
```

## アノテーション方法

### シワのアノテーション手順

1. **レビューウィンドウを開く**
   - 「OK画像をレビュー」ボタンをクリック

2. **シワをマーク**
   - 「シワをアノテーション」ボタンをクリック
   - アノテーションツールが開く

3. **ポリゴンを描画**
   - 左クリック: シワの輪郭に沿って頂点を追加
   - 右クリック: ポリゴンを完成
   - ESC: 現在のポリゴンをキャンセル

4. **複数のシワをマーク**
   - 1つの画像に複数のシワがある場合、繰り返す

5. **保存**
   - 「保存して閉じる」でYOLO形式で保存
   - 同じフォルダに .txt ファイルが生成される

### アノテーション基準

- **OK品**: 小規模なシワ（許容範囲）はアノテーション不要
- **NG品**: 検出したいシワのみをアノテーション
- **横シワ**: 横方向の線状のシワ
- **最小サイズ**: 5mm以上のシワをマーク

## 実装済み機能

### データ収集
- ✅ YOLOによるボトル自動検出
- ✅ 自動撮影機能（撮影間隔調整可能）
- ✅ OK/NG手動分類
- ✅ 進捗表示（目標1500枚/1500枚）

### アノテーション
- ✅ ポリゴンベースのシワアノテーション
- ✅ YOLO形式での保存
- ✅ レビュー機能との統合

### データセット準備
- ✅ 訓練/検証の自動分割（80/20）
- ✅ YOLO形式への変換
- ✅ dataset.yaml自動生成

## 開発ロードマップ

### 完了
- ✅ データ収集機能
- ✅ アノテーションツール
- ✅ データセット準備スクリプト

### 次のステップ
1. データ収集: 3000枚撮影
2. アノテーション: NG品のシワをマーク
3. YOLOv8学習: 100エポック
4. 精度評価: 90%以上を目標
5. main.pyへの統合: リアルタイム検出

## トラブルシューティング

### カメラが認識されない
- USB3.0ポートに接続されているか確認
- StCamUSBPackが正しくインストールされているか確認
- デバイスマネージャーでカメラが認識されているか確認

### 画像が暗すぎる
- 露出時間を増やす（10,000 → 15,000μs）
- ゲインを上げる（12 → 15dB）
- レンズの絞りを開放（F1.6）にする

### シワが検出されない
- 照明を強くする
- 2値化閾値を下げる（200 → 180）
- シワ判定閾値を下げる（5 → 3本）

### 誤検出が多い
- 2値化閾値を上げる（200 → 220）
- シワ判定閾値を上げる（5 → 7本）

## ファイル構成

```
wrinkle_detection/
├── main.py                    # メインアプリ（データ収集・レビュー）
├── annotation_tool.py         # シワアノテーションツール
├── prepare_yolo_dataset.py   # YOLOデータセット準備
├── camera_control.py          # カメラ制御
├── image_processing.py        # YOLO検出
├── config.py                  # 設定
├── utils.py                   # ユーティリティ
├── requirements.txt           # 依存ライブラリ
├── dataset/                   # 収集した画像
│   ├── ok/                   # OK品（目標1500枚）
│   └── ng/                   # NG品（目標1500枚）
└── yolo_dataset/             # YOLO学習用（自動生成）
    ├── images/
    │   ├── train/
    │   └── val/
    ├── labels/
    │   ├── train/
    │   └── val/
    └── dataset.yaml
```

## ライセンス
社内プロジェクト

## 更新履歴
- 2025-11-03: YOLOv8学習版に移行、アノテーション機能追加
- 2025-10-29: カメラ起動遅延問題を修正
- 2025-10-27: Phase 1 初版作成
