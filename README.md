# シャンパンボトル シワ検査システム - Phase 1

オリジナルシャンパンボトルのシュリンクフィルムに発生するシワを自動検出するシステムの概念実証版です。

## プロジェクト概要

### 目的
- シュリンクフィルムのシワを自動検出
- 従来の画像処理手法（トップライト露出オーバー手法）の有効性を検証
- 検出精度70%以上を目標

### 背景
- 柄が無限にあるため、従来の画像処理では精度50-65%が限界
- まずは画像処理で試し、効果が不十分ならAI手法へ移行

## ハードウェア構成

### 購入済み機材
1. **カメラ**: オムロンセンテック STC-MCS231U3V（79,980円）
2. **レンズ**: Dioche 8mm F1.6 CCTVレンズ（6,869円）
3. **USBケーブル**: UGREEN USB3.0 MicroB 2m（1,399円）
4. **PC**: ASUS Vivobook 15 X1502VA（所有済み）

### 今後必要な機材
- **照明（LED）**: 5,000-30,000円
- **カメラ固定治具**: 5,000-10,000円（準備済み）

## ソフトウェア構成

### システム要件
- OS: Windows
- Python: 3.8以上
- StCamUSBPack: インストール済み

### ファイル構成
```
wrinkle_detection/
├── main.py              # メインプログラム（GUI付き）
├── camera_control.py    # STC-MCS231U3Vカメラ制御
├── image_processing.py  # シワ検出アルゴリズム
├── config.py           # カメラ設定・検出パラメータ
├── utils.py            # ログ・画像保存等
├── requirements.txt    # 必要なライブラリ
├── CLAUDE.md           # Claude Code開発ガイド
├── README.md           # このファイル
├── test_images/        # テスト画像保存
└── results/            # 検出結果保存
```

## セットアップ

### 1. Pythonライブラリのインストール

```bash
cd wrinkle_detection
pip install -r requirements.txt
```

### 2. カメラドライバ確認
- StCamUSBPackがインストールされていることを確認
- カメラをUSB3.0ポートに接続

### 3. 初回起動

```bash
python main.py
```

## 使い方

### 基本操作

1. **カメラ起動**
   - 「カメラ起動」ボタンをクリック
   - プレビュー画面に映像が表示される

2. **カメラ設定の調整**
   - **露出時間**: 5,000-20,000μs（初期値: 10,000μs）
     - シワを強調するため、露出オーバー気味に設定
   - **ゲイン**: 0-20dB（初期値: 12dB）
     - 暗い場合はゲインを上げる

3. **検出パラメータの調整**
   - **2値化閾値**: 100-255（初期値: 200）
     - 値が高いほど暗い部分のみを検出
   - **シワ判定閾値**: 1-20本（初期値: 5本）
     - 検出された線が何本以上でNGと判定するか

4. **検査実行**
   - ボトルをカメラの前に配置
   - 「検査実行」ボタンをクリック
   - 結果が「検査結果」欄に表示される

5. **結果確認**
   - OK/NGの判定
   - 検出された線の本数
   - 統計情報（総数、OK数、NG数）
   - NG品の画像は自動的に`results/`フォルダに保存される

## 検出アルゴリズム

### トップライト露出オーバー手法

```
入力画像
  ↓
1. グレースケール変換
  ↓
2. 2値化（明るい部分を除去、影=シワを強調）
  ↓
3. ノイズ除去（モルフォロジー処理）
  ↓
4. エッジ検出（Canny）
  ↓
5. 線検出（Hough変換）
  ↓
6. 判定（検出線数 ≥ 閾値 → NG）
```

### シワの特徴
- 縦の線状シワ（継ぎ目付近）
- 斜めのシワ（肩部分）
- 表面の凹凸・歪み

## 評価基準

### Phase 1判定基準
- **検出率70%以上**: Phase 2へ（偏光フィルタ等の改善）
- **検出率50-70%**: Phase 2へ（改善余地あり）
- **検出率50%未満**: Phase 3へ（レーザー3D計測を検討）

## テスト計画

### Week 1
- 機材セットアップ
- ソフトウェア動作確認
- 基本的な調整

### Week 2
- 実ボトルでテスト（良品50本、NG品50本）
- 照明・露出の最適化
- 精度測定

## トラブルシューティング

### カメラが認識されない
- USB3.0ポートに接続されているか確認
- StCamUSBPackが正しくインストールされているか確認
- デバイスマネージャーでカメラが認識されているか確認

### 画像が暗すぎる
- 露出時間を増やす（10,000 → 15,000μs）
- ゲインを上げる（12 → 15dB）
- レンズの絞りを開放（F1.6）にする

### シワが検出されない
- 照明を強くする
- 2値化閾値を下げる（200 → 180）
- シワ判定閾値を下げる（5 → 3本）

### 誤検出が多い
- 2値化閾値を上げる（200 → 220）
- シワ判定閾値を上げる（5 → 7本）

## 今後の予定

### Phase 2: 精度改善（必要に応じて）
- 偏光フィルタの追加
- カメラ2台構成の検討
- アルゴリズムの改良

### Phase 3: レーザー3D計測（Phase 2で不十分な場合）
- レーザースキャナの導入
- 3D解析による高精度検出
- 目標精度: 90-95%

## ライセンス
社内プロジェクト

## 更新履歴
- 2025-10-27: Phase 1 初版作成
