# Photometric Stereo - フォトメトリックステレオ実験

3方向からの照明で撮影した画像から法線マップを計算し、表面の3D形状を推定する実験ツール。

## 原理

Woodhamのフォトメトリックステレオ法:
- 異なる方向から光を当てた3枚以上の画像を撮影
- 各画素の輝度値と光源方向から法線ベクトルを推定
- 式: `N * rho = L^(-1) * I`
  - N: 法線ベクトル
  - rho: アルベド（反射率）
  - L: 光源方向行列
  - I: 輝度値ベクトル

## 使い方

### 起動

```bash
python photometric_stereo.py
```

### カメラ設定

- **回転**: 0, 90, 180, 270 から選択可能
- **露出時間**: 1000-100000 us
- **ゲイン**: 0-30 dB

### 光源キャリブレーション（球を使用）

光沢のある球（パチンコ玉、ベアリング球など）を使って光源方向を自動推定:

1. キャリブレーション用の球を撮影範囲に配置
2. LED1を点灯して「LED1キャリブ」ボタンを押す
3. キャリブレーションウィンドウで:
   - 球の中心をクリックし、輪郭までドラッグして球を指定
   - 「ハイライト検出」ボタンで光源方向を自動計算
   - 「適用」で設定に反映
4. LED2, LED3も同様にキャリブレーション

### 撮影手順

1. LED1を点灯（他は消灯）→「LED1撮影」ボタン
2. LED2を点灯（他は消灯）→「LED2撮影」ボタン
3. LED3を点灯（他は消灯）→「LED3撮影」ボタン
4. 「法線マップ計算」ボタンで計算

### 光源設定（手動）

キャリブレーションを使わない場合、各LEDの位置を方位角と仰角で直接指定:
- **方位角 (Azimuth)**: XY平面上の角度（0=正面、反時計回り）
- **仰角 (Elevation)**: 水平面からの角度（45が一般的）

デフォルト設定（120間隔、仰角45）:
- LED1: 方位角 0, 仰角 45
- LED2: 方位角 120, 仰角 45
- LED3: 方位角 240, 仰角 45

### 出力

`photometric_output/` フォルダに保存:
- `normal_map_*.png` - 法線マップ（RGB = XYZ方向）
- `albedo_*.png` - アルベド（反射率）マップ
- `led1_*.png`, `led2_*.png`, `led3_*.png` - 元画像
- `config_*.txt` - 撮影時の設定

## キャリブレーションの原理

鏡面球上のハイライト（反射点）から光源方向を計算:

1. 球面上のハイライト位置を検出
2. ハイライトの2D座標から球面上の3D法線を計算
3. 鏡面反射の法則から光源方向ベクトルを算出
   - L = 2(N・V)N - V （V: 視線方向、N: 法線）

## 注意事項

- 撮影時は1つのLEDのみ点灯し、他は消灯すること
- カメラと被写体の位置は固定すること
- キャリブレーション用の球は光沢があるものを使用（鏡面反射が必要）
- 露出は白飛びしない範囲で明るめに設定

## 参考

- [フォトメトリックステレオの解説記事](https://raccoon15.hatenablog.com/entry/2018/08/13/202523)
